<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | –°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: rgba(15, 23, 42, .95);
            --accent: #6366f1;
            --danger: #ef4444;
            --success: #10b981;
            --text: #e2e8f0;
            --sub: #94a3b8;
            --border: rgba(148, 163, 184, .1);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #1e1b4b 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--panel);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, .5);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            padding: 30px 40px;
            border-bottom: 1px solid var(--border);
        }
        h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -.5px;
            margin-bottom: 8px;
        }
        .subtitle {
            font-size: 14px;
            opacity: .7;
        }
        h2 {
            font-size: 22px;
            margin-bottom: 20px;
        }
        .section {
            padding: 40px;
            display: none;
            animation: fadeIn .3s ease-in;
        }
        .section.active {
            display: block;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .warehouse-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .warehouse-btn {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            color: #f8fafc;
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            transition: all .2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px;
            word-break: break-word;
        }
        .warehouse-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -3px rgba(0, 0, 0, 0.4);
        }
        .warehouse-btn:active {
            transform: scale(.97);
            opacity: .9;
        }
        label {
            display: block;
            margin: 15px 0 6px;
            font-weight: 500;
            font-size: 13px;
            color: #cbd5e1;
        }
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(30, 41, 59, .5);
            color: #f1f5f9;
            font-size: 16px;
            transition: all .2s ease;
        }
        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, .2);
        }
        button {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: #fff;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all .2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -3px rgba(0, 0, 0, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%);
        }
        button.secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -3px rgba(0, 0, 0, 0.4);
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin: 15px 0;
            max-width: 350px;
            background: rgba(30, 41, 59, .3);
            padding: 15px;
            border-radius: 12px;
        }
        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 10px 4px;
            background: rgba(99, 102, 241, .1);
            color: #c7d2fe;
            border-radius: 6px;
            font-size: 12px;
        }
        button.date-btn {
            height: 42px;
            padding: 8px;
            border: 1px solid var(--border);
            background: rgba(51, 65, 85, .5);
            color: #cbd5e1;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
        }
        button.date-btn.selected {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: #fff;
            border-color: var(--accent);
        }
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 15px;
        }
        .category-input {
            background: rgba(30, 41, 59, .3);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }
        .input-row,
        .input-triple,
        .input-double {
            display: grid;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-row {
            grid-template-columns: 1fr 1fr;
        }
        .input-triple {
            grid-template-columns: 1fr 1fr 1fr;
        }
        .input-double {
            grid-template-columns: 1fr 1fr;
        }
        .yesno-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .yesno-btn {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all .2s;
        }
        .yesno-btn.yes {
            background: rgba(239, 68, 68, .2);
            color: #f87171;
            border-color: rgba(239, 68, 68, .3);
        }
        .yesno-btn.yes.selected {
            background: var(--danger);
            color: #fff;
            border-color: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, .4);
        }
        .yesno-btn.no {
            background: rgba(34, 197, 94, .2);
            color: #34d399;
            border-color: rgba(34, 197, 94, .3);
        }
        .yesno-btn.no.selected {
            background: var(--success);
            color: #fff;
            border-color: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, .4);
        }
        .delta-display {
            padding: 8px 12px;
            background: rgba(30, 41, 59, .5);
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            margin-top: 10px;
        }
        .table-wrapper {
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        table {
            width: auto;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            font-size: 10px;
            table-layout: auto;
            background: rgba(15, 23, 42, .5);
        }
        th,
        td {
            border: 1px solid rgba(71, 85, 105, .3);
            padding: 6px 4px;
            text-align: center;
            color: #cbd5e1;
            white-space: normal;
            word-break: break-word;
            min-width: 50px;
        }
        th {
            font-size: 8px;
            line-height: 1.2;
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            position: sticky;
            top: 0;
            z-index: 10;
            color: #e0e7ff;
            font-weight: 600;
        }
        td:first-child,
        th:first-child {
            min-width: 140px;
            font-size: 8px;
            text-align: left;
            padding-left: 10px;
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 5;
            white-space: nowrap;
        }
        td:nth-child(2),
        th:nth-child(2) {
            min-width: 50px;
            font-size: 8px;
        }
        .positive {
            color: #34d399;
            font-weight: 600;
        }
        .negative {
            color: #f87171;
            font-weight: 600;
        }
        .good {
            color: #34d399;
        }
        .bad {
            color: #f87171;
        }
        .summary-total {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            border-radius: 12px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #e0e7ff;
        }
        .full-screen-table {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(15, 23, 42, .98);
            z-index: 1000;
            overflow: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .close-full {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, .5);
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .large-button {
            width: 100%;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            box-shadow: 0 10px 25px -5px rgba(5, 150, 105, .4);
        }
        #console-output {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            max-width: 45%;
            background: rgba(15, 23, 42, .95);
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 12px 12px 0 0;
            padding: 8px 16px;
            font-size: 11px;
            color: #94a3b8;
            font-family: 'Courier New', monospace;
            z-index: 998;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, .3);
            pointer-events: none;
            max-height: 40px;
            overflow: hidden;
        }
        #console-output::before {
            content: '‚öôÔ∏è ';
            color: #8b5cf6;
        }
        /* =====  MOBILE  ===== */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            .header {
                padding: 16px;
            }
            h1 {
                font-size: 22px;
            }
            .subtitle {
                font-size: 12px;
            }
            .section {
                padding: 16px;
            }
            .warehouse-list {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .warehouse-btn {
                min-height: 48px;
                font-size: 14px;
                padding: 12px 16px;
            }
            .calendar {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                padding: 10px;
            }
            .calendar-header {
                font-size: 11px;
                padding: 8px 4px;
            }
            button.date-btn {
                height: 40px;
                font-size: 14px;
            }
            .input-row,
            .input-triple,
            .input-double {
                grid-template-columns: 1fr;
            }
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            table {
                font-size: 9px;
            }
            th,
            td {
                padding: 4px 3px;
                min-width: 60px;
            }
            th:first-child,
            td:first-child {
                position: sticky;
                left: 0;
                z-index: 2;
                background: #1e3a8a;
            }
            button {
                min-height: 48px;
                font-size: 16px;
                padding: 12px 16px;
            }
            .yesno-buttons {
                flex-direction: row;
            }
            .yesno-btn {
                padding: 14px;
                font-size: 16px;
            }
            #console-output {
                width: 96%;
                max-width: 96%;
                left: 2%;
                transform: none;
                font-size: 10px;
                padding: 6px 10px;
            }
            .action-buttons {
                position: sticky;
                bottom: 0;
                background: rgba(15, 23, 42, .95);
                backdrop-filter: blur(6px);
                padding: 8px 0;
                margin: 24px -16px -16px -16px;
                justify-content: space-around;
                border-top: 1px solid var(--border);
            }
            .action-buttons button {
                flex: 1 1 45%;
                margin: 4px;
            }
        }
        @media (hover: none) and (max-width: 768px) {
            .warehouse-btn:hover,
            button:hover {
                transform: none;
                box-shadow: none;
            }
            .warehouse-btn:active,
            button:active {
                transform: scale(.97);
                opacity: .9;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –°–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h1>
            <div class="subtitle">–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–∫–ª–∞–¥—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</div>
        </div>

        <!-- –ì–ª–∞–≤–Ω–∞—è: –°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤ -->
        <div id="mainSection" class="section active">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</h2>
            <div class="warehouse-list" id="warehouseList"></div>
            <button class="large-button" onclick="showSummarySection()">üìä –û–±—â–∏–π —Å–≤–æ–¥ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º</button>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –ø–æ —Å–∫–ª–∞–¥—É -->
        <div id="warehouseReportSection" class="section">
            <h2 id="warehouseTitle">–û—Ç—á—ë—Ç –ø–æ —Å–∫–ª–∞–¥—É</h2>
            <div class="date-section">
                <h3>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h3>
                <div class="calendar-controls">
                    <button class="secondary" onclick="prevPeriod()">‚Äπ</button>
                    <button class="secondary" onclick="toggleCalendarView()">
                        <span id="warehouseViewToggleText">üìÜ –ú–µ—Å—è—Ü</span>
                    </button>
                    <button class="secondary" onclick="nextPeriod()">‚Ä∫</button>
                </div>
                <div id="warehouseCalendar" class="calendar"></div>
                <div id="selectedWarehouseDate" class="selected-date-display"></div>
            </div>
            <div class="radio-group">
                <label><input type="radio" name="warehouseReportType" value="day" checked> ‚òÄÔ∏è –î–Ω–µ–≤–Ω–∞—è —Å–º–µ–Ω–∞</label>
                <label><input type="radio" name="warehouseReportType" value="night"> üåô –ù–æ—á–Ω–∞—è —Å–º–µ–Ω–∞</label>
            </div>
            <form id="reportForm">
                <div id="categoryInputs"></div>
                <div class="action-buttons">
                    <button type="button" onclick="saveWarehouseReport()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á—ë—Ç</button>
                    <button type="button" class="secondary" onclick="showMainSection()">‚Äπ –ù–∞–∑–∞–¥ –∫ —Å–∫–ª–∞–¥–∞–º</button>
                </div>
            </form>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –æ–±—â–µ–≥–æ —Å–≤–æ–¥–∞ -->
        <div id="summarySection" class="section">
            <h2>üìä –û–±—â–∏–π —Å–≤–æ–¥ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º</h2>
            <div class="filter-group" style="display:flex;gap:20px;flex-wrap:wrap;align-items:end;margin:15px 0">
                <div>
                    <label><input type="checkbox" id="summaryDay" checked> ‚òÄÔ∏è –î–µ–Ω—å</label>
                </div>
                <div>
                    <label><input type="checkbox" id="summaryNight"> üåô –ù–æ—á—å</label>
                </div>
                <div>
                    <label>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:</label>
                    <select id="summaryManager">
                        <option value="">–í—Å–µ</option>
                        <option value="–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è 1 –®—É—Ç–∏–Ω –î.–ú.">–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è 1 –®—É—Ç–∏–Ω –î.–ú.</option>
                        <option value="–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è 2 –õ—é–±–∞–≤–∫—Å–∫–∞—è –ú.–ò.">–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è 2 –õ—é–±–∞–≤–∫—Å–∫–∞—è –ú.–ò.</option>
                    </select>
                </div>
            </div>
            <div class="date-section">
                <h3>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h3>
                <div class="calendar-controls">
                    <button class="secondary" onclick="prevPeriodSummary()">‚Äπ</button>
                    <button class="secondary" onclick="toggleCalendarViewSummary()">
                        <span id="summaryViewToggleText">üìÜ –ú–µ—Å—è—Ü</span>
                    </button>
                    <button class="secondary" onclick="nextPeriodSummary()">‚Ä∫</button>
                </div>
                <div id="summaryCalendar" class="calendar"></div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–≤–æ–¥–∞ -->
        <div id="summaryTableSection" class="section">
            <h2>üìã –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
            <div class="date-section">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:15px">
                    <button class="secondary" onclick="prevSummaryDay()">‚Äπ</button>
                    <div style="display:flex;align-items:center;gap:10px;text-align:center;font-size:18px;font-weight:600;color:#c7d2fe" id="currentSummaryDate"></div>
                    <button class="secondary" onclick="nextSummaryDay()">‚Ä∫</button>
                </div>
            </div>
            <div id="summaryTable"></div>
            <div class="action-buttons">
                <button onclick="exportToExcel()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                <button onclick="toggleFullScreen()">üñ•Ô∏è –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
                <button class="secondary" onclick="showSummarySection()">‚Äπ –ù–∞–∑–∞–¥</button>
            </div>
        </div>
    </div>

    <!-- Full-screen —Ç–∞–±–ª–∏—Ü–∞ -->
    <div id="fullScreenTable" class="full-screen-table" style="display:none">
        <button class="close-full" onclick="toggleFullScreen()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        <div id="fullSummaryTable"></div>
    </div>

    <!-- –ö–æ–Ω—Å–æ–ª—å –≤–Ω–∏–∑—É -->
    <div id="console-output"></div>

    <script>
        /* ========== CONFIG ========== */
        const WAREHOUSES = [
            "–ê–†–•–ê–ù–ì–ï–õ–¨–°–ö_–•–ê–ë_–ù–ê–•–ò–ú–û–í–ê",
            "–ú–£–†–ú–ê–ù–°–ö_–•–ê–ë_–û–ë–™–ï–ó–î–ù–ê–Ø",
            "–í–ï–õ–ò–ö–ò–ô_–ù–û–í–ì–û–†–û–î_–•–ê–ë_–ù–ï–•–ò–ù–°–ö–ê–Ø",
            "–ü–ï–¢–†–û–ó–ê–í–û–î–°–ö_–•–ê–ë_–ü–†–Ø–ñ–ò–ù–°–ö–û–ï",
            "–ü–°–ö–û–í_–•–ê–ë_–ú–ê–†–ì–ï–õ–û–í–ê",
            "–ü–°–ö–û–í_–•–ê–ë_–ù–û–í–´–ô",
            "–°–´–ö–¢–´–í–ö–ê–†_–•–ê–ë_–õ–ï–°–û–ü–ê–†–ö–û–í–ê–Ø",
            "–°–´–ö–¢–´–í–ö–ê–†_–•–ê–ë_–û–ö–¢–Ø–ë–†–¨–°–ö–ò–ô",
            "–ß–ï–†–ï–ü–û–í–ï–¶_–•–ê–ë_–°–¢–†–û–ô–ò–ù–î–£–°–¢–†–ò–ò",
            "–í–û–õ–û–ì–î–ê_–•–ê–ë_–ë–ï–õ–û–ó–ï–†–°–ö–û–ï"
        ];
        const CATEGORIES = [
            {name: '–û–±—Ä–∞–±–æ—Ç–∫–∞', type: 'number'},
            {name: '–ü–µ—Ä—Å–æ–Ω–∞–ª', type: 'number'},
            {name: '–û–∫–æ–Ω—á–∞–Ω–∏–µ –≤—ã–¥–∞—á–∏', type: 'time'},
            {name: '–û–±—Ä–∞–±–æ—Ç–∫–∞ FBS', type: 'number'},
            {name: '–í–æ–∑–≤—Ä–∞—Ç–Ω—ã–π –ø–æ—Ç–æ–∫ (–ë—ç–∫–ª–æ–≥)', type: 'number'},
            {name: '–û–±–µ–∑–ª–∏—á–∫–∞', type: 'single', label: '–ü–æ–¥–¥–æ–Ω—ã', unit: '—à—Ç'},
            {name: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', type: 'number'},
            {name: '–ö–æ–ª-–≤–æ –ø–∞–ª–ª–µ—Ç–∞-–º–µ—Å—Ç –∫ –æ—Ç–≥—Ä—É–∑–∫–µ', type: 'triple', fields: [{n: 'FBS', u: '—à—Ç'}, {n: 'X-Dock', u: '—à—Ç'}, {n: '–í–æ–∑–≤—Ä–∞—Ç—ã', u: '—à—Ç'}]},
            {name: '–•—Ä–æ–Ω—å –•–î', type: 'double', fields: [{n: '–°–æ—Ä—Ç', u: '—à—Ç'}, {n: '–ù–æ–Ω-–°–æ—Ä—Ç', u: '—à—Ç'}]},
            {name: '–†–∏—Å–∫–∏', type: 'yesno'},
            {name: '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –í—ã–¥–∞—á–∞', type: 'single', label: '–ó–Ω–∞—á–µ–Ω–∏–µ', unit: '—à—Ç'},
            {name: '% –Ω–µ –ø—Ä–æ—Ñ–∏–ª—è', type: 'single', label: '–ü—Ä–æ—Ü–µ–Ω—Ç', unit: '%'},
            {name: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', type: 'select', options: ['–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è 1 –®—É—Ç–∏–Ω –î.–ú.', '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è 2 –õ—é–±–∞–≤–∫—Å–∫–∞—è –ú.–ò.']}
        ];

        let reports = JSON.parse(localStorage.getItem('warehouseReports')) || {};
        let currentDate = new Date();
        let warehouseCalendarView = 'week';
        let summaryCalendarView = 'week';
        let selectedWarehouseDate = null;
        let selectedSummaryDate = null;
        let currentWarehouse = '';

        /* ========== INIT ========== */
        window.onload = () => {
            cleanOldReports();
            generateWarehouseList();
            renderWarehouseCalendar();
            renderSummaryCalendar();
            fillTestData();

            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            document.getElementById('summaryDay').addEventListener('change', autoUpdateSummary);
            document.getElementById('summaryNight').addEventListener('change', autoUpdateSummary);
            document.getElementById('summaryManager').addEventListener('change', autoUpdateSummary);
        };

        function autoUpdateSummary() {
            if (document.getElementById('summaryTableSection').classList.contains('active')) {
                showSummaryData();
            }
        }

        /* ========== UTILS ========== */
        function cleanOldReports() {
            const six = new Date(); six.setMonth(six.getMonth() - 6);
            for (let k in reports) {
                const [d, m, y] = k.split('.').map(Number);
                if (new Date(y, m - 1, d) < six) delete reports[k];
            }
            localStorage.setItem('warehouseReports', JSON.stringify(reports));
        }

        function parseTimeToMin(str) {
            const p = str.split(':');
            if (p.length !== 2) return NaN;
            return (parseInt(p[0]) || 0) * 60 + (parseInt(p[1]) || 0);
        }

        function fillTestData() {
            const today = new Date();
            const testDates = Array.from({length: 5}, (_, i) => {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                return d.toLocaleDateString('ru-RU');
            });
            const testWh = ["–í–ï–õ–ò–ö–ò–ô_–ù–û–í–ì–û–†–û–î_–•–ê–ë_–ù–ï–•–ò–ù–°–ö–ê–Ø", "–ü–°–ö–û–í_–•–ê–ë_–ù–û–í–´–ô", "–í–û–õ–û–ì–î–ê_–•–ê–ë_–ë–ï–õ–û–ó–ï–†–°–ö–û–ï"];
            testDates.forEach(dateStr => {
                if (!reports[dateStr]) reports[dateStr] = {};
                testWh.forEach((wh, idx) => {
                    if (!reports[dateStr][wh]) reports[dateStr][wh] = {};
                    reports[dateStr][wh].day = {
                        '–û–±—Ä–∞–±–æ—Ç–∫–∞': {plan: String(200 + idx * 30), fact: String(210 + idx * 30), delta: 10},
                        '–ü–µ—Ä—Å–æ–Ω–∞–ª': {plan: String(15 + idx), fact: String(15 + idx), delta: 0},
                        '–û–∫–æ–Ω—á–∞–Ω–∏–µ –≤—ã–¥–∞—á–∏': {plan: '12:30', fact: '12:25', delta: '–ù–æ—Ä–º–∞'},
                        '–û–±—Ä–∞–±–æ—Ç–∫–∞ FBS': {plan: String(12 + idx), fact: String(11 + idx), delta: -1},
                        '–í–æ–∑–≤—Ä–∞—Ç–Ω—ã–π –ø–æ—Ç–æ–∫ (–ë—ç–∫–ª–æ–≥)': {plan: '5', fact: '7', delta: 2},
                        '–û–±–µ–∑–ª–∏—á–∫–∞': {value: String(10 + idx)},
                        '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': {plan: String(95 + idx), fact: String(98 + idx), delta: 3},
                        '–ö–æ–ª-–≤–æ –ø–∞–ª–ª–µ—Ç–∞-–º–µ—Å—Ç –∫ –æ—Ç–≥—Ä—É–∑–∫–µ': {FBS: String(20 + idx), 'X-Dock': String(15 + idx), –í–æ–∑–≤—Ä–∞—Ç—ã: String(5 + idx)},
                        '–•—Ä–æ–Ω—å –•–î': {–°–æ—Ä—Ç: String(30 + idx), '–ù–æ–Ω-–°–æ—Ä—Ç': String(25 + idx)},
                        '–†–∏—Å–∫–∏': {value: idx % 2 === 0 ? 'yes' : 'no'},
                        '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –í—ã–¥–∞—á–∞': {value: String(50 + idx * 10)},
                        '% –Ω–µ –ø—Ä–æ—Ñ–∏–ª—è': {value: String(5 + idx)},
                        '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å': {value: idx % 2 === 0 ? '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è 1 –®—É—Ç–∏–Ω –î.–ú.' : '–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è 2 –õ—é–±–∞–≤–∫—Å–∫–∞—è –ú.–ò.'}
                    };
                    reports[dateStr][wh].night = JSON.parse(JSON.stringify(reports[dateStr][wh].day));
                });
            });
            localStorage.setItem('warehouseReports', JSON.stringify(reports));
        }

        /* ========== NAVIGATION ========== */
        function generateWarehouseList() {
            const list = document.getElementById('warehouseList');
            list.innerHTML = '';
            WAREHOUSES.forEach(wh => {
                const btn = document.createElement('button');
                btn.className = 'warehouse-btn';
                btn.textContent = wh;
                btn.onclick = () => showWarehouseReport(wh);
                list.appendChild(btn);
            });
        }

        function showWarehouseReport(wh) {
            currentWarehouse = wh;
            document.getElementById('warehouseTitle').textContent = `üìç ${wh}`;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('warehouseReportSection').classList.add('active');
            selectedWarehouseDate = currentDate.toLocaleDateString('ru-RU');
            document.getElementById('selectedWarehouseDate').innerHTML = `<strong>–í—ã–±—Ä–∞–Ω–æ:</strong> ${selectedWarehouseDate}`;
            renderWarehouseCalendar();
            loadCategoryInputs();
        }

        function showMainSection() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('mainSection').classList.add('active');
        }

        function showSummarySection() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('summarySection').classList.add('active');
            selectedSummaryDate = currentDate.toLocaleDateString('ru-RU');
            renderSummaryCalendar();
        }

        /* ========== CALENDAR ========== */
        function renderCalendar(calId, view, onSelect, selectedStr) {
            const cal = document.getElementById(calId);
            cal.innerHTML = '';
            const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
            const headerRow = document.createElement('div');
            headerRow.style.display = 'grid';
            headerRow.style.gridTemplateColumns = 'repeat(7, 1fr)';
            headerRow.style.gap = '4px';
            days.forEach(d => {
                const h = document.createElement('div');
                h.className = 'calendar-header';
                h.textContent = d;
                headerRow.appendChild(h);
            });
            cal.appendChild(headerRow);

            let dates = [];
            if (view === 'week') {
                const mon = new Date(currentDate);
                mon.setDate(mon.getDate() - ((mon.getDay() || 7) - 1));
                for (let i = 0; i < 7; i++) {
                    const d = new Date(mon);
                    d.setDate(mon.getDate() + i);
                    dates.push({ date: d, day: d.getDate(), empty: false });
                }
            } else {
                const y = currentDate.getFullYear(), m = currentDate.getMonth();
                const first = new Date(y, m, 1), last = new Date(y, m + 1, 0), start = first.getDay() || 7;
                for (let i = 0; i < start - 1; i++) {
                    const b = document.createElement('button');
                    b.className = 'date-btn empty';
                    b.disabled = true;
                    cal.appendChild(b);
                }
                for (let day = 1; day <= last.getDate(); day++) {
                    const d = new Date(y, m, day);
                    dates.push({ date: d, day, empty: false });
                }
            }

            const dateRow = document.createElement('div');
            dateRow.style.display = 'grid';
            dateRow.style.gridTemplateColumns = 'repeat(7, 1fr)';
            dateRow.style.gap = '4px';

            dates.forEach(o => {
                const b = document.createElement('button');
                b.className = 'date-btn';
                b.textContent = o.day;
                if (o.date.toLocaleDateString('ru-RU') === selectedStr) b.classList.add('selected');
                b.onclick = () => onSelect(o.date);
                dateRow.appendChild(b);
            });

            cal.appendChild(dateRow);
        }

        function renderWarehouseCalendar() {
            renderCalendar('warehouseCalendar', warehouseCalendarView, selectWarehouseDate, selectedWarehouseDate);
        }

        function renderSummaryCalendar() {
            renderCalendar('summaryCalendar', summaryCalendarView, selectSummaryDate, selectedSummaryDate || currentDate.toLocaleDateString('ru-RU'));
        }

        function selectWarehouseDate(d) {
            selectedWarehouseDate = d.toLocaleDateString('ru-RU');
            document.getElementById('selectedWarehouseDate').innerHTML = `<strong>–í—ã–±—Ä–∞–Ω–æ:</strong> ${selectedWarehouseDate}`;
            renderWarehouseCalendar();
            loadCategoryInputs();
        }

        function selectSummaryDate(d) {
            selectedSummaryDate = d.toLocaleDateString('ru-RU');
            renderSummaryCalendar();
        }

        function prevPeriod() {
            if (warehouseCalendarView === 'week') {
                currentDate.setDate(currentDate.getDate() - 7);
            } else {
                currentDate.setMonth(currentDate.getMonth() - 1);
            }
            renderWarehouseCalendar();
        }

        function nextPeriod() {
            if (warehouseCalendarView === 'week') {
                currentDate.setDate(currentDate.getDate() + 7);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            renderWarehouseCalendar();
        }

        function toggleCalendarView() {
            warehouseCalendarView = warehouseCalendarView === 'week' ? 'month' : 'week';
            document.getElementById('warehouseViewToggleText').textContent = warehouseCalendarView === 'week' ? 'üìÜ –ú–µ—Å—è—Ü' : 'üìÖ –ù–µ–¥–µ–ª—è';
            renderWarehouseCalendar();
        }

        function prevPeriodSummary() {
            if (summaryCalendarView === 'week') {
                currentDate.setDate(currentDate.getDate() - 7);
            } else {
                currentDate.setMonth(currentDate.getMonth() - 1);
            }
            renderSummaryCalendar();
        }

        function nextPeriodSummary() {
            if (summaryCalendarView === 'week') {
                currentDate.setDate(currentDate.getDate() + 7);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            renderSummaryCalendar();
        }

        function toggleCalendarViewSummary() {
            summaryCalendarView = summaryCalendarView === 'week' ? 'month' : 'week';
            document.getElementById('summaryViewToggleText').textContent = summaryCalendarView === 'week' ? 'üìÜ –ú–µ—Å—è—Ü' : 'üìÖ –ù–µ–¥–µ–ª—è';
            renderSummaryCalendar();
        }

        /* ========== FORM ========== */
        function loadCategoryInputs() {
            if (!selectedWarehouseDate) return;
            const type = document.querySelector('input[name="warehouseReportType"]:checked').value;
            const div = document.getElementById('categoryInputs');
            div.innerHTML = '';

            CATEGORIES.forEach(cat => {
                const data = reports[selectedWarehouseDate]?.[currentWarehouse]?.[type]?.[cat.name] || {};
                const cd = document.createElement('div');
                cd.className = 'category-input';
                let html = `<h4>${cat.name}</h4>`;

                if (cat.type === 'number') {
                    html += `<div class="input-row">
                        <div><label>–ü–ª–∞–Ω:</label><input type="number" id="${currentWarehouse}_${type}_${cat.name}_plan" placeholder="–ü–ª–∞–Ω" inputmode="numeric" value="${data.plan || ''}"></div>
                        <div><label>–§–∞–∫—Ç:</label><input type="number" id="${currentWarehouse}_${type}_${cat.name}_fact" placeholder="–§–∞–∫—Ç" inputmode="numeric" value="${data.fact || ''}"></div>
                    </div>
                    <div class="delta-display">–î–µ–ª—å—Ç–∞: <span id="${currentWarehouse}_${type}_${cat.name}_delta"></span></div>`;
                } else if (cat.type === 'time') {
                    html += `<div class="input-row">
                        <div><label>–ü–ª–∞–Ω (–ß–ß:–ú–ú):</label><input type="text" id="${currentWarehouse}_${type}_${cat.name}_plan" placeholder="12:30" value="${data.plan || ''}"></div>
                        <div><label>–§–∞–∫—Ç (–ß–ß:–ú–ú):</label><input type="text" id="${currentWarehouse}_${type}_${cat.name}_fact" placeholder="12:25" value="${data.fact || ''}"></div>
                    </div>
                    <div class="delta-display"><span id="${currentWarehouse}_${type}_${cat.name}_delta"></span></div>`;
                } else if (cat.type === 'single') {
                    html += `<div><label>${cat.label} (${cat.unit}):</label><input type="number" id="${currentWarehouse}_${type}_${cat.name}_value" placeholder="${cat.label}" inputmode="numeric" value="${data.value || ''}"></div>`;
                } else if (cat.type === 'triple') {
                    html += `<div class="input-triple">`;
                    cat.fields.forEach(f => html += `<div><label>${f.n} (${f.u}):</label><input type="number" id="${currentWarehouse}_${type}_${cat.name}_${f.n}" placeholder="${f.n}" inputmode="numeric" value="${data[f.n] || ''}"></div>`);
                    html += `</div>`;
                } else if (cat.type === 'double') {
                    html += `<div class="input-double">`;
                    cat.fields.forEach(f => html += `<div><label>${f.n} (${f.u}):</label><input type="number" id="${currentWarehouse}_${type}_${cat.name}_${f.n}" placeholder="${f.n}" inputmode="numeric" value="${data[f.n] || ''}"></div>`);
                    html += `</div>`;
                } else if (cat.type === 'yesno') {
                    const val = data.value || '';
                    html += `<div class="yesno-buttons">
                        <button type="button" class="yesno-btn yes ${val === 'yes' ? 'selected' : ''}" onclick="selectYesNo('${currentWarehouse}','${type}','${cat.name}','yes',event)">–î–ê</button>
                        <button type="button" class="yesno-btn no ${val === 'no' ? 'selected' : ''}" onclick="selectYesNo('${currentWarehouse}','${type}','${cat.name}','no',event)">–ù–ï–¢</button>
                    </div>
                    <input type="hidden" id="${currentWarehouse}_${type}_${cat.name}_value" value="${val}">`;
                } else if (cat.type === 'select') {
                    html += `<div><label>–í—ã–±–µ—Ä–∏—Ç–µ:</label><select id="${currentWarehouse}_${type}_${cat.name}_value">
                        <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>`;
                    cat.options.forEach(opt => html += `<option value="${opt}" ${data.value === opt ? 'selected' : ''}>${opt}</option>`);
                    html += `</select></div>`;
                }
                cd.innerHTML = html;
                div.appendChild(cd);

                if (cat.type === 'number' || cat.type === 'time') {
                    const planEl = document.getElementById(`${currentWarehouse}_${type}_${cat.name}_plan`);
                    const factEl = document.getElementById(`${currentWarehouse}_${type}_${cat.name}_fact`);
                    if (!planEl || !factEl) return;
                    const update = () => {
                        const plan = planEl.value.trim(), fact = factEl.value.trim();
                        const span = document.getElementById(`${currentWarehouse}_${type}_${cat.name}_delta`);
                        if (!span) return;
                        if (cat.type === 'number') {
                            const p = parseInt(plan) || 0, f = parseInt(fact) || 0, delta = f - p;
                            span.textContent = delta;
                            span.className = delta >= 0 ? 'positive' : 'negative';
                        } else if (cat.type === 'time') {
                            if (plan && fact) {
                                const pMin = parseTimeToMin(plan), fMin = parseTimeToMin(fact);
                                if (!isNaN(pMin) && !isNaN(fMin)) {
                                    const ok = fMin <= pMin;
                                    span.textContent = ok ? '–ù–æ—Ä–º–∞' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ';
                                    span.className = ok ? 'positive' : 'negative';
                                } else {
                                    span.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–ß–ß:–ú–ú)';
                                    span.className = 'negative';
                                }
                            } else {
                                span.textContent = '';
                            }
                        }
                    };
                    planEl.addEventListener('input', update);
                    factEl.addEventListener('input', update);
                    update();
                }
            });
        }

        function selectYesNo(wh, t, cat, val, e) {
            e.preventDefault();
            document.getElementById(`${wh}_${t}_${cat}_value`).value = val;
            e.target.parentElement.querySelectorAll('.yesno-btn').forEach(b => b.classList.remove('selected'));
            e.target.classList.add('selected');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const radios = document.querySelectorAll('input[name="warehouseReportType"]');
            radios.forEach(r => r.addEventListener('change', loadCategoryInputs));
        });

        function saveWarehouseReport() {
            if (!selectedWarehouseDate) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É!');
            const type = document.querySelector('input[name="warehouseReportType"]:checked').value;
            if (!reports[selectedWarehouseDate]) reports[selectedWarehouseDate] = {};
            if (!reports[selectedWarehouseDate][currentWarehouse]) reports[selectedWarehouseDate][currentWarehouse] = {};
            if (!reports[selectedWarehouseDate][currentWarehouse][type]) reports[selectedWarehouseDate][currentWarehouse][type] = {};

            CATEGORIES.forEach(cat => {
                let data = {};
                if (cat.type === 'number' || cat.type === 'time') {
                    const planEl = document.getElementById(`${currentWarehouse}_${type}_${cat.name}_plan`);
                    const factEl = document.getElementById(`${currentWarehouse}_${type}_${cat.name}_fact`);
                    if (planEl && factEl) {
                        const plan = planEl.value.trim(), fact = factEl.value.trim();
                        let delta = '';
                        if (cat.type === 'number') {
                            const p = parseInt(plan) || 0, f = parseInt(fact) || 0;
                            delta = f - p;
                        } else if (cat.type === 'time') {
                            if (plan && fact) {
                                const pMin = parseTimeToMin(plan), fMin = parseTimeToMin(fact);
                                if (!isNaN(pMin) && !isNaN(fMin)) delta = fMin <= pMin ? '–ù–æ—Ä–º–∞' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ';
                            }
                        }
                        data = { plan, fact, delta };
                    }
                } else if (cat.type === 'single' || cat.type === 'yesno' || cat.type === 'select') {
                    const el = document.getElementById(`${currentWarehouse}_${type}_${cat.name}_value`);
                    if (el) data = { value: el.value.trim() };
                } else if (cat.type === 'triple' || cat.type === 'double') {
                    cat.fields.forEach(f => {
                        const el = document.getElementById(`${currentWarehouse}_${type}_${cat.name}_${f.n}`);
                        if (el) data[f.n] = el.value.trim();
                    });
                }
                reports[selectedWarehouseDate][currentWarehouse][type][cat.name] = data;
            });

            localStorage.setItem('warehouseReports', JSON.stringify(reports));
            cleanOldReports();
            alert('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
            showMainSection();
        }

        /* ========== SUMMARY TABLE ========== */
        function showSummaryData() {
            if (!selectedSummaryDate) return alert('‚ö†Ô∏è –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –¥–∞—Ç—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ!');
            const includeDay = document.getElementById('summaryDay').checked;
            const includeNight = document.getElementById('summaryNight').checked;
            const managerFilter = document.getElementById('summaryManager').value;
            if (!includeDay && !includeNight) return alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø –æ—Ç—á—ë—Ç–∞!');

            document.getElementById('currentSummaryDate').textContent = selectedSummaryDate;
            document.getElementById('summarySection').classList.remove('active');
            document.getElementById('summaryTableSection').classList.add('active');

            const tableDiv = document.getElementById('summaryTable');
            let html = '<div class="table-wrapper"><table><thead><tr><th>–°–∫–ª–∞–¥</th><th>–•–ê</th>';

            CATEGORIES.forEach(cat => {
                if (cat.type === 'single' || cat.type === 'yesno' || cat.type === 'select') {
                    html += `<th colspan="1">${cat.name}</th>`;
                } else if (cat.type === 'triple') {
                    html += `<th colspan="3">${cat.name}</th>`;
                } else if (cat.type === 'double') {
                    html += `<th colspan="2">${cat.name}</th>`;
                } else {
                    html += `<th colspan="3">${cat.name}</th>`;
                }
            });
            html += '<th>–¢–∏–ø</th></tr><tr style="background:linear-gradient(135deg,#1e3a8a 0%,#312e81 100%)"><th colspan="2"></th>';

            CATEGORIES.forEach(cat => {
                if (cat.type === 'single' || cat.type === 'yesno' || cat.type === 'select') {
                    html += `<th>${cat.label || cat.unit || ''}</th>`;
                } else if (cat.type === 'triple') {
                    cat.fields.forEach(f => html += `<th>${f.u}</th>`);
                } else if (cat.type === 'double') {
                    cat.fields.forEach(f => html += `<th>${f.u}</th>`);
                } else {
                    html += '<th>–ü</th><th>–§</th><th>Œî</th>';
                }
            });
            html += '<th>–¢–∏–ø</th></tr></thead><tbody>';

            const warehouseData = reports[selectedSummaryDate] || {};
            WAREHOUSES.forEach(wh => {
                const whData = warehouseData[wh] || {};
                let rowAdded = false;
                if (includeDay && whData.day) {
                    if (managerFilter === '' || whData.day.–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å?.value === managerFilter) {
                        html += addRow(wh, whData.day, '‚òÄÔ∏è');
                        rowAdded = true;
                    }
                }
                if (includeNight && whData.night) {
                    if (managerFilter === '' || whData.night.–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å?.value === managerFilter) {
                        html += addRow(wh, whData.night, 'üåô');
                        rowAdded = true;
                    }
                }
                if (!rowAdded) {
                    let cells = `<td>${wh}</td><td>–•–ê</td>`;
                    const numDataCols = CATEGORIES.reduce((acc, cat) => {
                        if (cat.type === 'single' || cat.type === 'yesno' || cat.type === 'select') return acc + 1;
                        if (cat.type === 'triple') return acc + 3;
                        if (cat.type === 'double') return acc + 2;
                        return acc + 3;
                    }, 0);
                    for (let i = 0; i < numDataCols; i++) cells += '<td>-</td>';
                    cells += '<td>-</td>';
                    html += `<tr>${cells}</tr>`;
                }
            });

            html += '</tbody></table></div>';
            tableDiv.innerHTML = html;
        }

        function addRow(wh, typeData, typeLabel) {
            let html = `<tr><td>${wh}</td><td>–•–ê</td>`;
            CATEGORIES.forEach(cat => {
                const data = typeData[cat.name] || {};
                if (cat.type === 'single') {
                    html += `<td>${data.value || '-'}</td>`;
                } else if (cat.type === 'yesno') {
                    const val = data.value || '';
                    const isBad = val === 'yes';
                    html += `<td class="${isBad ? 'bad' : (val ? 'good' : '')}">${val ? (isBad ? '‚ùå' : '‚úÖ') : '-'}</td>`;
                } else if (cat.type === 'select') {
                    html += `<td>${data.value || '-'}</td>`;
                } else if (cat.type === 'triple') {
                    cat.fields.forEach(f => html += `<td>${data[f.n] || '-'}</td>`);
                } else if (cat.type === 'double') {
                    cat.fields.forEach(f => html += `<td>${data[f.n] || '-'}</td>`);
                } else if (cat.type === 'time') {
                    html += `<td>${data.plan || '-'}</td><td>${data.fact || '-'}</td>`;
                    const deltaText = data.delta || '';
                    const isGood = deltaText === '–ù–æ—Ä–º–∞';
                    html += `<td class="${isGood ? 'good' : (deltaText ? 'bad' : '')}">${deltaText ? (isGood ? '‚úÖ' : '‚ùå') : '-'}</td>`;
                } else {
                    html += `<td>${data.plan || '-'}</td><td>${data.fact || '-'}</td>`;
                    const deltaCell = data.delta !== undefined && data.delta !== '' ? data.delta : '-';
                    const deltaClass = typeof deltaCell === 'number' ? (deltaCell >= 0 ? 'positive' : 'negative') : '';
                    html += `<td class="${deltaClass}">${deltaCell}</td>`;
                }
            });
            html += `<td>${typeLabel}</td></tr>`;
            return html;
        }

        function toggleFullScreen() {
            const fs = document.getElementById('fullScreenTable');
            const tbl = document.getElementById('summaryTable');
            if (fs.style.display === 'none') {
                document.getElementById('fullSummaryTable').innerHTML = tbl.innerHTML;
                fs.style.display = 'block';
                document.body.style.overflow = 'hidden';
            } else {
                fs.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function prevSummaryDay() {
            if (!selectedSummaryDate) return;
            const [d, m, y] = selectedSummaryDate.split('.').map(Number);
            const date = new Date(y, m - 1, d);
            date.setDate(date.getDate() - 1);
            selectedSummaryDate = date.toLocaleDateString('ru-RU');
            document.getElementById('currentSummaryDate').textContent = selectedSummaryDate;
            showSummaryData();
        }

        function nextSummaryDay() {
            if (!selectedSummaryDate) return;
            const [d, m, y] = selectedSummaryDate.split('.').map(Number);
            const date = new Date(y, m - 1, d);
            date.setDate(date.getDate() + 1);
            selectedSummaryDate = date.toLocaleDateString('ru-RU');
            document.getElementById('currentSummaryDate').textContent = selectedSummaryDate;
            showSummaryData();
        }

        /* ========== –≠–ö–°–ü–û–†–¢ –í EXCEL ========== */
        function exportToExcel() {
            const table = document.querySelector('#summaryTable table');
            if (!table) {
                alert('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            const wb = XLSX.utils.table_to_book(table, {sheet: "–°–≤–æ–¥"});
            const fileName = `–°–≤–æ–¥_${selectedSummaryDate.replace(/\./g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>